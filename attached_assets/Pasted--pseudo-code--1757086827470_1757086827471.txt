// إعدادات
const CHUNK_DURATION = 30; // بالثواني لكل مقطع
let finalText = "";

// دالة لحساب مدة التسجيل الحقيقية
function getAudioDuration(audioFile) {
  return new Promise((resolve, reject) => {
    const audio = new Audio();
    audio.src = URL.createObjectURL(audioFile);
    audio.addEventListener('loadedmetadata', () => {
      resolve(audio.duration); // مدة التسجيل بالثواني
    });
    audio.addEventListener('error', (err) => reject(err));
  });
}

// دالة لتقسيم التسجيل الطويل إلى مقاطع
function splitAudio(audioFile, totalDuration, chunkDuration = CHUNK_DURATION) {
  const numChunks = Math.ceil(totalDuration / chunkDuration);
  let chunks = [];
  for (let i = 0; i < numChunks; i++) {
    // slice/segment logic هنا حسب نوع الملف ومكتبة التعامل مع الصوت
    const start = i * chunkDuration;
    const end = Math.min((i + 1) * chunkDuration, totalDuration);
    chunks.push({ start, end }); // فقط مؤشرات البداية والنهاية لكل مقطع
  }
  return chunks;
}

// دالة لمعالجة كل مقطع وتحويله إلى نص باللهجة الجزائرية
async function processChunk(chunk) {
  try {
    const text = await convertAudioToText(chunk, { language: "ar-DZ" });
    return text;
  } catch (error) {
    console.error("خطأ في معالجة المقطع:", error);
    return "";
  } finally {
    // تحرير الذاكرة بعد المعالجة
    chunk = null;
  }
}

// الدالة الرئيسية لمعالجة التسجيل الكامل
async function processFullAudio(audioFile) {
  try {
    const totalDuration = await getAudioDuration(audioFile);
    console.log("⏱️ مدة التسجيل الحقيقية:", totalDuration, "ثانية");

    const chunks = splitAudio(audioFile, totalDuration);

    for (let i = 0; i < chunks.length; i++) {
      console.log(`🔄 معالجة المقطع ${i + 1} من ${chunks.length}...`);
      const text = await processChunk(chunks[i]);
      finalText += text + " "; // دمج النصوص الجزئية
      console.log(`✅ انتهى المقطع ${i + 1}`);
    }

    console.log("✅ النص النهائي كامل:");
    console.log(finalText);

    // إرسال النص النهائي للتلخيص
    const summary = await summarizeText(finalText);
    displaySummary(summary);

  } catch (error) {
    console.error("خطأ في معالجة التسجيل الكامل:", error);
  }
}
